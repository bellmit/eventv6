/*
 * Mr.rexs <Mr.rexs@uoeye.com>
 */
/*
 * 猪八戒WebIM 插件
 * 作者：Mr.rexs <Mr.rexs@uoeye.com>
 * 接口：
 *  WebIM.message(UID,UserName,Online,EventType,EventID,EventName,Extend);
    * @UID {Intger} 用户ID
    * @UserName {String} 用户名
    * @Online {Intger} 是否在线
    * @EventType {ints} 事件类型   1/任务 2/稿件【需要扩展属性 extend】 3/服务
    * @EventID {Int} 事件ID
    * @EventName {String} 事件名
    * @Extend {String} 扩展属性 为2的时候需要
 *
 * 例子：
 *  <a href="javascript:;" onclick="WebIM.message(1,'ba',1,1,111,'baiduadsf')"></a>
 */
(function(){function f(a,b){try{return a.contains?a!=b&&a.contains(b):!!(a.compareDocumentPosition(b)&16)}catch(c){}}function g(a){return a.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()})}function h(a){return a.replace(/[A-Z]/g,function(a,b){return"-"+a.toLowerCase()})}function D(a,b){var c=WebIM.Storage.get(a,!0);return function(d){setTimeout(function(){var e;d=d||M.storageEvent,e=d.key,newValue=d.newValue;if(!e||WebIM.Storage.triggerSelf){var f=WebIM.Storage.get(a,!0);f!=c&&(e=a,newValue=f)}e==a&&b&&b(c=newValue)},0)}}function E(a,b,c){if(!a.useTimer)document.attachEvent&&!WebIM.Browser.opera?L.attachEvent("onstorage",D(b,c)):M.addEventListener("storage",D(b,c),!1);else{var d=D(b,c);setInterval(function(){d({})},a.interval)}}function U(){}var a=+(new Date),b,c=window.WebIM={};WebIM.$=function(a){return document.getElementById(a)},WebIM.$class=function(a,b){var c,d=[];b=b||document;if(b.getElementsByClassName)return b.getElementsByClassName(a);c=b.getElementsByTagName("*");var e=new RegExp("(^|\\s)"+a+"(\\s|$)","i");for(var f in c)e.test(c[f].className)&&(d[d.length]=c[f]);return d},WebIM.$tag=function(a,b){return b=b||document,b.getElementsByTagName(a)},WebIM.$html=function(a){var b=document.createElement("div"),c,d=[];b.innerHTML=a;if((c=b.childNodes).length){delete b;for(var e=0,f=c.length;e<f;e++)c[e].nodeType==1&&c[e].tagName&&(d[d.length]=c[e])}return d},WebIM.cookie=function(a){var b=new RegExp("(?:[s;]?|^)"+a+"=([^;]*|$)","i"),c;return c=document.cookie.match(b),c?decodeURIComponent(c[1]):null},WebIM.offset=function(a){var b=Math.max(document.documentElement.scrollTop,document.body.scrollTop),c=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),d=a.getBoundingClientRect();return{top:d.top+b,left:d.left+c}},WebIM.addEvent=document.addEventListener?function(a,b,c){return a.addEventListener(b,c,!1)}:function(a,b,c){return a.attachEvent("on"+b,c)},WebIM.removeEvent=document.removeEventListener?function(a,b,c){return a.removeEventListener(b,c,!1)}:function(a,b,c){return a.detachEvent("on"+b,c)},WebIM.parent=function(a,b){var c=a,d=0;while(c.nodeName.toLowerCase()!=b&&d++<10)c=c.parentNode;return c},WebIM.tpl=function(a,b){var c=a,d;for(var e in b)d=new RegExp("{"+e+"}","ig"),c=c.replace(d,b[e]);return c},WebIM.parseJSON=function(a){};var d=null,e=document.getElementsByTagName("head")[0];WebIM.jsonp=function(a,b,c,f){f&&f(),d&&(d.parentNode.removeChild(d),d=null),d=document.createElement("script"),d.async="async",d.type="text/javascript",d.onload=d.onreadystatechange=function(){P.test(d.readyState)&&(b&&b(),d.onload=d.onreadystatechange=null)},d.onerror=function(){c&&c()},d.src=a,e.appendChild(d)},WebIM.fixedEvent=function(){var a=document.documentElement,b=document.body;return function(c){return!c.target&&(c.target=c.srcElement||document),c.target.nodeType===3&&(c.target=c.target.parentNode),!c.relatedTarget&&c.fromElement&&(c.relatedTarget=c.fromElement===c.target?c.toElement:c.fromElement),c.pageX==null&&c.clientX!=null&&(c.pageX=c.clientX+(a&&a.scrollLeft||b&&b.scrollLeft||0)-(a&&a.clientLeft||b&&b.clientLeft||0),c.pageY=c.clientY+(a&&a.scrollTop||b&&b.scrollTop||0)-(a&&a.clientTop||b&&b.clientTop||0)),!c.which&&(c.charCode||c.charCode===0?c.charCode:c.keyCode)&&(c.which=c.charCode||c.keyCode),!c.metaKey&&c.ctrlKey&&(c.metaKey=c.ctrlKey),!c.which&&c.button!==undefined&&(c.which=c.button&1?1:c.button&2?3:c.button&4?2:0),c}}(),WebIM.Browser=function(){var a=window.navigator,b=a.userAgent.toLowerCase(),c=/(msie|webkit|gecko|presto|opera|safari|firefox|chrome|maxthon)[ \/]([\d.]+)/ig,d={platform:a.platform};b.replace(c,function(a,b,c){d[b.toLowerCase()]=c}),d.opera&&b.replace(/opera.*version\/([\d.]+)/,function(a,b){d.opera=b});if(d.msie){d.ie=d.msie;var e=parseInt(d.msie,10);d["ie"+e]=!0}return d}(),WebIM.userselect=function(a,b){a?WebIM.Browser.gecko?(l(document.body,"-moz-user-select",""),b&&l(b,"-moz-user-select","")):document.onselectstart=function(){return!0}:WebIM.Browser.gecko?(l(document.body,"-moz-user-select"," -moz-none"),b&&l(b,"-moz-user-select"," -moz-none")):document.onselectstart=function(){return!1}},WebIM.mouseenter=function(a,b){if(WebIM.Browser.ie)WebIM.addEvent(a,"mouseenter",b);else{function c(a){var c=a.currentTarget,d=a.relatedTarget;!f(c,d)&&c!=d&&b.call(a.currentTarget,a)}WebIM.addEvent(a,"mouseover",c)}},WebIM.mouselever=function(a,b){if(WebIM.Browser.ie)WebIM.addEvent(a,"mouseleave",b);else{function c(a){var c=a.currentTarget,d=a.relatedTarget;!f(c,d)&&c!=d&&b.call(a.currentTarget,a)}WebIM.addEvent(a,"mouseout",c)}},WebIM.hover=function(a,b,c){WebIM.mouseenter(a,b),WebIM.mouselever(a,c)},WebIM.show=function(a){a.style.display="block"},WebIM.hide=function(a){a.style.display="none"},WebIM.addClass=function(a,b){var c=a.className,d=new RegExp("(^|\\s)"+b+"(\\s|$)","ig");d.test(c)||(c+=" "+b,a.className=c)},WebIM.removeClass=function(a,b){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","ig");a.className=a.className.replace(c,"")},WebIM.removeAt=function(a,b){for(var c=a.length-1;c>=0;c--)if(b==a[c])return a.splice(c,1);return a},WebIM.isPlainObject=function(){var a=Object.prototype.hasOwnProperty;return function(b){if(!b||Object.prototype.toString.call(b)!=="[object Object]"||b.nodeType||b.setInterval)return!1;if(b.constructor&&!a.call(b,"constructor")&&!a.call(b.constructor.prototype,"isPrototypeOf"))return!1;var c;for(c in b);return c===undefined||a.call(b,c)}}();var i=document.createElement("div");i.style.display="none",i.innerHTML="<a href='#' style='color:red;float:left;opacity:.55;'>a</a>",i.setAttribute("class","t");var j=i.getElementsByTagName("a")[0];WebIM.support={attfix:i.className==="t",opacity:/^0.55$/.test(j.style.opacity),cssFloat:!!j.style.cssFloat};var k=WebIM.getStyle=function(){var a=/^(left|right|top|bottom)$/;return function(b,c){var d=null;return b=b.documentElement||b,b.nodeType===1&&typeof c=="string"&&!/^html|body$/i.test(b.nodeName)&&(c=g(c),c=c==="float"?WebIM.support.cssFloat?"cssFloat":"styleFloat":c,d=b.style[c]?b.style[c]:window.getComputedStyle?function(){return getComputedStyle(b,null)[c]}():function(){var a=b.currentStyle[c];if(c!=="width"&&c!=="height"||a!=="auto"){if(c==="opacity"){var e=b.currentStyle.filter;return/opacity/.test(e)?(a=(e.match(/\d+/)[0]^0)/100,a^0!=a?a.toFxed(2):a):a===undefined?1:a}return a}var d=b.getBoundingClientRect();return c==="width"?d.right-d.left:d.bottom-d.top}(),d==="auto"&&a.test(c)&&(d="0px")),d}}(),l=WebIM.setStyle=function(){return function(a,b,c){var d=[],e=arguments[3],f;b=h(b);if(WebIM.isPlainObject(b)){for(var g in b)d[d.length]=l(a,g,b[g],!0);c=!0}else c&&(b==="opacity"&&!WebIM.support.opacity?d[d.length]="filter:alpha(opacity="+c*100+");":d[d.length]=b+":"+c+";");!c&&(a.style.cssText=a.style.cssText.replace(new RegExp(";?"+b+"[-:s][^;]+","ig"),""));if(e)return d.join("");a.style.cssText+=";"+d.join("")}}();WebIM.serialize=function(a){var b="",c=[];if(a instanceof Array){b+="[";for(var d in a)a[d]instanceof Array||WebIM.isPlainObject(a[d])?c[c.length]=WebIM.serialize(a[d]):c[c.length]=typeof a[d]=="number"?a[d]:'"'+a[d]+'"';b+=c.join(",")+"]"}else if(WebIM.isPlainObject(a)){b+="{";for(var d in a)WebIM.isPlainObject(a[d])||a[d]instanceof Array?c[c.length]=d+":"+WebIM.serialize(a[d]):c[c.length]=d+":"+(typeof a[d]=="number"?a[d]:'"'+a[d]+'"')}},WebIM.extend=function(){var a,b=arguments,c=b.length,d=!1,e=0,f,g,h;typeof b[0]=="boolean"&&(d=!!b[0],e=1),a=c<3?e?Maya.fn:c===1?Maya.fn:b[e]:b[e];while(e<c){for(h in b[e])f=b[e][h],g=a[h],a[h]=d&&(Maya.isPlainObject(f)||Maya.isArray(f))?Maya.mix(!0,Maya.isPlainObject(g)||Maya.isArray(g)?g:Maya.isArray(f)?[]:{},f):f;e++}return a},WebIM.animate=function(){var a=arguments;if(!(this instanceof arguments.callee))return new arguments.callee(a[0],a[1],a[2],a[3],a[4],a[5]);this.item=a[0],this.defCallback=a[4],this.defSpeed=a[2],this.defEasing=a[3],this.defStep=a[5],this.disin(a[1])},WebIM.animate.off=!1,WebIM.animate.prototype={disin:function(a){var b,c,d,e,f,h=this,i,j;this.queue={};if(WebIM.isPlainObject(a))for(var k in a){b=g(k),c=a[k];if(i=WebIM.isPlainObject(c))c=c.style;d=i?a[k].speed||this.defSpeed:this.defSpeed,f=i?a[k].easing||this.defEasing:this.defEasing,e=i?a[k].callback||null:null,j=i?a[k].step||null:this.defStep,this.queue[b]=WebIM.animate.fx(this,b,c,d,f,e,j)}this.timeId=setInterval(function(){h.step()},13)},step:function(){for(var a in this.queue)this.queue[a].step&&this.queue[a].step()},stop:function(){for(var a in this.queue)this.queue[a].step(!0),delete this.queue[a];this.defCallback&&this.defCallback(this),this.destroy(),clearInterval(this.timeId)},destroy:function(){delete this.queue,delete this.timeId}};var m=/([^\d]*)([\d\.]*)([^\d]*)/,n=/^rgb\((\d+)[,\s]*(\d+)[,\s]*(\d+)\);*/i,o=/^#[0-9a-fA-F]{3}|[0-9a-fA-F]{6}/;WebIM.animate.color={color2aco:function(a){var b;return o.test(a)?this.hex2aco(a.substr(1)):(b=a.match(n))?this.rgb2aco(b):null},aco2hex:function(a){var b=["#"],c;for(var d=0,e=a.length;d<e;d++)c=Math.ceil(a[d]).toString(16),b[b.length]=c.length==1?"0"+c:c;return b.join("")},hex2aco:function(a){var b=[],c,d=a.split("");c=d.length>3?1:0;for(var e=0,f=d.length;e<f;e+=c+1)b[b.length]=parseInt(c?d[e]+d[e+1]:d[e]+d[e],16);return b},rgb2aco:function(a){return[a[1]^0,a[2]^0,a[3]^0]}},WebIM.animate.fx=function(a,b,c,d,e,f,g){if(!(this instanceof arguments.callee))return new arguments.callee(a,b,c,d,e,f,g);this.animate=a,this.rule=b,this.speed=d,this.easing=e,this.callback=f,this.stepcall=g,this.custom(c+"")},WebIM.animate.fx.prototype={fixColor:{backgroundColor:1,color:1,borderLeftColor:1,borderRightColor:1,borderBottomColor:1,borderTopColor:1},custom:function(a){var b,c=this;if(!(b=k(this.animate.item,this.rule)))return;this.endval=a;if(this.rule in this.fixColor){this.start=WebIM.animate.color.color2aco(b),this.end=WebIM.animate.color.color2aco(a),this.pos=this.state==0;if(this.start===null||this.end===null)return}else b=b.match(m),a=a.match(m),this.uuit=a[3]||b[3]||"px",this.start=b[2]^0,this.end=a[2]^0,this.pos=this.state=0,this.endval+=this.uuit;this.startTime=+(new Date)},stop:function(a){!a&&this.step(!0),this.callback&&this.callback(this)},step:function(a){var b=+(new Date),c,d,e=[];if(a)return l(this.animate.item,this.rule,this.endval),this.stop(!0);c=b-this.startTime,this.state=c/this.speed,this.pos=(WebIM.easing[this.easing]||WebIM.easing.linear)(this.state,c,0,1,this.speed);if(b-this.startTime>this.speed)return this.step(!0);this.uuit?d=this.start+(this.end-this.start)*this.pos+"px":(e[0]=this.start[0]+(this.end[0]-this.start[0])*this.pos,e[1]=this.start[1]+(this.end[1]-this.start[1])*this.pos,e[2]=this.start[2]+(this.end[2]-this.start[2])*this.pos,d=WebIM.animate.color.aco2hex(e)),this.stepcall&&this.stepcall(this,d),l(this.animate.item,this.rule,d)}},WebIM.easing={linear:function(a,b,c,d){return c+d*a},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?d*7.5625*b*b+c:b<2/2.75?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:b<2.5/2.75?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c}};var p=function(a,b,c,d){this.entry(a,b,c,d)};p.prototype={entry:function(a,b,d,e){this.parent=a,this.Window=b,this.client=d,this.upcaller=e,this.parentHeight=parseInt(c.getStyle(a,"height"),10),this.parentWidth=parseInt(c.getStyle(a,"width"),10),this.WinWidth=parseInt(c.getStyle(b,"width"),10),this.WinHeight=parseInt(c.getStyle(b,"height"),10),this.bind()},bind:function(){this.client.bind("mousedown"),this.client.addListener("window-move",this.down,this)},up:function(a){var b=WebIM.Drag;c.removeEvent(document.body,"mouseup",b.up),c.removeEvent(document.body,"mousemove",b.move),WebIM.userselect(!0,b.parent),b.cx&&b.upcaller(b.cx,b.cy)},move:function(a){a=c.fixedEvent(window.event||a);var b=WebIM.Drag,d,e,f;d=a.pageX-b.oldPageX,e=a.pageY-b.oldPageY,d=b.WindowOffset.left+d,e=b.WindowOffset.top+e;if(f=b.limit(d,e))b.setPosition(d,e,f.x,f.y),f.x&&(b.cx=d),f.y&&(b.cy=e)},setPosition:function(a,b,c,d){arguments.length<=2&&(c=1,d=1),c&&(this.Window.style.left=a+"px"),d&&(this.Window.style.top=b+"px")},limit:function(a,b){var c,d={x:1,y:1};if(a>0||(c=this.parentWidth+Math.abs(a))<this.WinWidth||c>this.width)d.x=0;if(b>0||(c=Math.abs(b)+this.parentHeight)<this.WinHeight||c>this.height)d.y=0;return d},down:function(a){a=c.fixedEvent(window.event||a);if(a.type!=="mousedown"||a.button==2)return;return this.parentOffset=c.offset(this.parent),this.WindowOffset={left:parseInt(c.getStyle(this.Window,"left"),10),top:parseInt(c.getStyle(this.Window,"top"),10)},this.oldPageX=a.pageX,this.oldPageY=a.pageY,this.width=document.documentElement.clientWidth||document.body.clientWidth,this.height=document.documentElement.clientHeight||document.body.clientHeight,c.addEvent(document.body,"mousemove",WebIM.Drag.move),this.setCapture(document.body),c.addEvent(document.body,"mouseup",WebIM.Drag.up),WebIM.userselect(!1,this.parent),this.cx=null,this.cy=null,!1},setCapture:function(a,b){return}},WebIM.Drag=p;var q='<object data="{url}" type="application/x-mplayer2" width="0" height="0" style="position:absolute;top:-1000px;"><param name="src" value="{url}"><param name="autostart" value="1"><param name="playcount" value="infinite"/><embed src="{url}" height="45" width="250" autostart="true" /></object>',r=function(){},s=/\{url\}/g;r.prototype={player:null,play:function(a){if(this.player)try{this.player.parentNode.removeChild(this.player)}catch(b){}this.player=document.createElement("div"),this.player.style.position="position",this.player.style.top="-1000px",this.player.innerHTML=q.replace(s,a),document.body.appendChild(this.player)}},WebIM.Audio=new r;var t=[/[\uff10|\u96f6]/ig,/[\uff11|\u4e00|\u58f9|\u2160|\u3220|\u2474|\u2488|\u2460]/ig,/[\uff12|\u4e8c|\u8d30|\u2161|\u3221|\u2475|\u2489|\u2461]/ig,/[\uff13|\u4e09|\u53c1|\u2162|\u3222|\u2476|\u248a|\u2462]/ig,/[\uff14|\u56db|\u8086|\u2163|\u3223|\u2477|\u248b|\u2463]/ig,/[\uff15|\u4e94|\u4f0d|\u2164|\u3224|\u2478|\u248c|\u2464]/ig,/[\uff16|\u516d|\u9646|\u2165|\u3225|\u2479|\u248d|\u2465]/ig,/[\uff17|\u4e03|\u67d2|\u2166|\u3226|\u247a|\u248e|\u2466]/ig,/[\uff18|\u516b|\u634c|\u2167|\u3227|\u247b|\u248f|\u2467]/ig,/[\uff19|\u4e5d|\u7396|\u2168|\u3228|\u247c|\u2490|\u2468]/ig,/[\u5341|\u62fe|\u2169|\u3229|\u247d|\u2491|\u2469]/ig],u=[[0,["zero"]],[8,["eight","viii"]],[3,["three","iii"]],[7,["seven","vii"]],[2,["two","ii"]],[6,["six","vi"]],[1,["one"]],[4,["four","iv"]],[5,["five"]],[9,["nine","ix"]],[10,["ten"]]],v=["","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth"],w=/[0-9]{5,}/g,x=/[0-9](\s*[^0-9]{0,5}\s*[0-9]){5,}/ig,y=/<([^>]*)>/g,z=/[0-9\u4e00-\u9fa5a-z~!@#$%^&*()_+}{|":>?<,./;\'\[\]\\\`]/ig,A=function(){};A.prototype={result:"",rating:16,filter:function(a,b){return a=a.replace(/(^\s*|\s*$)/g,""),this.result=a,this.transform(),this.shield(),b||(this.result=this.result.replace(y,"$1")),{change:!this.cl,result:a}},shield:function(){this.result.match(w)?this.cl=!0:this.result.match(x)?this.cl=!0:this.cl=!1},transform:function(){var a,b,c;for(var d in t)this.result=this.result.replace(t[d],d);if(this.rating>=2)for(var d in u){b=u[d];for(var e in b[1])c=this.rating>4?this.getRating(b[1][e]):b[1][e],a=new RegExp("\\b"+c+"\\b","ig"),this.result=this.result.replace(a,b[0])}if(this.rating>=4)for(var d in v){if(!v[d])continue;b=this.rating>8?this.getRating(v[d]):v[d],this.result=this.result.replace(new RegExp("\\b"+b+"\\b","ig"),d+"th")}this.rating>16&&(this.result=this.result.replace(z,"*"))},getRating:function(a){return a.split("").join("[^\u4e00-\u9fa5a-z]{0,4}")}},WebIM.Filter=new A;var B=function(a){if(!(this instanceof B))return new B(a);this.options=c.extend({wrapper:null,content:null,inleft:!1,step:10},a),this.entry()};B.prototype={entry:function(){this.wrapper=this.options.wrapper.nodeType?this.options.wrapper:c.$(this.options.wrapper),this.content=this.options.content.nodeType?this.options.content:c.$(this.options.content),this.maxHeight=parseInt(c.getStyle(this.wrapper,"height"),10),this.createHelp(),this.reset(),this.bind()},createHelp:function(){var a=document.createElement("div");this.scroll=c.$html('<div class="ui-webim-scroll '+(this.options.inleft?"ui-webim-scrollLeft":"")+'"></div>')[0],c.setStyle(this.scroll,"height",this.maxHeight+"px"),this.scroll.innerHTML='<div  class="ui-webim-scrollarea" style="display:none;"></div><div class="ui-webim-scrollbar" style="display:none;"><b></b><i></i></div>',this.area=c.$class("ui-webim-scrollarea",this.scroll)[0],this.bar=c.$class("ui-webim-scrollbar",this.scroll)[0],this.wrapper.parentNode.insertBefore(a,this.wrapper),a.appendChild(this.scroll),a.style.position="relative",a.appendChild(this.wrapper),this.div=a,c.setStyle(a,"height",this.maxHeight+"px"),this.taskbar=c.$("ui-webim-taskbar"),this.barHeight=parseInt(c.getStyle(this.bar,"height"),10)},bind:function(){var a=this;c.hover(this.scroll,function(b){a.inscroll=!0,a.showBar()},function(b){a.inscroll=!1,WebIM.Scroll.self||(a.hideBar(),a.soffset=null)}),c.addEvent(this.scroll,"mousemove",function(b){if(a.barfixed)return!1;b=WebIM.fixedEvent(window.event||b),a.fixedBarPosition(b)}),c.addEvent(this.bar,"mouseover",function(){a.barfixed=!0}),c.addEvent(this.bar,"mouseout",function(){a.barfixed=!1}),c.addEvent(this.bar,"mousedown",function(b){b=WebIM.fixedEvent(window.event||b),a.barDown(b)}),c.addEvent(this.bar,"click",function(b){b=WebIM.fixedEvent(window.event||b);if(a.onlyMonsedown)return;b.target.nodeName=="B"?a.step(-a.options.step):a.step(a.options.step)}),this.addScrollListener()},addScrollListener:function(){var a=WebIM.Browser.gecko?"DOMMouseScroll":"mousewheel",b=this;c.addEvent(this.wrapper,a,function(a){a=WebIM.fixedEvent(window.event||a),a.preventDefault?a.preventDefault():a.returnValue=!1,b.step(((a.wheelDelta||a.detail)>0?-1:1)*(WebIM.Browser.gecko?-1:1)*b.options.step)})},barDown:function(a){var b=this;this.barPageY=a.pageY,this.barOldTop=parseInt(c.getStyle(this.bar,"top"),10),this.areaOldTop=this.areaTop,WebIM.Scroll.self=this,this.onlyMonsedown=!1,this.timer=setTimeout(function(){c.addEvent(document,"mousemove",b.barMove),b.scrollInt=!1,b.scrollTimer=setInterval(function(){b.scrollInt=!0,b.step(a.target.nodeName=="B"?-b.options.step:b.options.step)},50)},100),c.addEvent(document,"mouseup",this.barUp),WebIM.userselect(!1,this.taskbar)},barMove:function(a){var b=WebIM.Scroll.self,d,e,f;if(b.scrollInt)return;b.onlyMonsedown=!0,a=WebIM.fixedEvent(window.event||a),d=b.barOldTop+a.pageY-b.barPageY,b.scrollTimer&&(clearInterval(b.scrollTimer),b.scrollTimer=null),d>=0&&d<=b.maxHeight-b.barHeight&&(c.setStyle(b.bar,"top",d+"px"),d<b.barOldTop?e=b.areaOldTop+(d-b.barOldTop)*b.areaOldTop/b.barOldTop:e=(d-b.barOldTop)*(b.maxHeight-b.areaHeight-b.areaOldTop)/(b.maxHeight-b.barHeight-b.barOldTop)+b.areaOldTop,!isNaN(e)&&b.go(e))},barUp:function(a){var b=WebIM.Scroll.self;b.scrollTimer&&(clearInterval(b.scrollTimer),b.scrollTimer=null),c.removeEvent(document,"mousemove",b.barMove),c.removeEvent(document,"mouseup",b.barUp),!b.inscroll&&b.hideBar(),clearTimeout(b.timer),b.timer=null,WebIM.Scroll.self=null,WebIM.userselect(!0,b.taskbar)},fixedBarPosition:function(a){var b,d;return this.soffset||(this.soffset=WebIM.offset(this.scroll)),d=a.pageY-this.soffset.top,b=d-this.barHeight/2,b>=0&&b<=this.maxHeight-this.barHeight&&c.setStyle(this.bar,"top",b+"px"),a},step:function(a){var b=this.areaTop+a,c;b=b<=0?0:b>=(c=this.maxHeight-this.areaHeight)?c:b,this.go(b),this.timer&&(clearTimeout(this.timer),this.timer=null)},go:function(a,b){if(!this.areaIsShow)return;var d;a=Math.floor(a),this.areaTop=a,c.setStyle(this.area,"top",a+"px"),d=b||this.getContHeight(),a=-(a*(d-this.maxHeight))/(this.maxHeight-this.areaHeight),c.setStyle(this.content,"margin-top",a+"px")},reset:function(a){var b=this.getContHeight();b>this.maxHeight?(this.showArea(),a&&this.step(3e3)):this.hideArea()},getContHeight:function(){return parseInt(c.getStyle(this.content,"height"),10)},showBar:function(){this.areaIsShow&&(c.setStyle(this.bar,"display","block"),this.barIsShow=!0)},hideBar:function(){c.setStyle(this.bar,"display","none"),this.barIsShow=!1},showArea:function(a){c.setStyle(this.area,"display","block"),this.areaIsShow=!0,this.resetArea(a)},resetArea:function(a){var b,d;a=a||this.getContHeight(),b=this.maxHeight*this.maxHeight,this.areaHeight=Math.floor(b/a),c.setStyle(this.area,"height",this.areaHeight+"px"),this.resetAreaMarginTop(a)},resetAreaMarginTop:function(a){var b=c.getStyle(this.content,"margin-top");a=a||this.getContHeight(),b=isNaN(b)?0:Math.abs(parseInt(b,10)),this.areaTop=b,c.setStyle(this.area,"top",b+"px")},hideArea:function(){c.setStyle(this.area,"display","none"),this.areaIsShow=!1},resetHeight:function(){c.setStyle(this.div,"height",this.maxHeight+"px"),c.setStyle(this.scroll,"height",this.maxHeight+"px")}},WebIM.Scroll=B;var C=function(){};C.prototype={get:function(a,b){var c=N.get(a);return c?b?c:this.unserialize(c):c},set:function(a,b){typeof b=="object"?b=this.serialize(b):b=this.safetyFilter(""+b);if(a!="STORAGEKEY"){var c=this.get("STORAGEKEY",!0)||"";(""+c).indexOf(","+a)==-1&&(c+=","+a,this.set("STORAGEKEY",c))}return N.set(a,b)},unserialize:function(a){var b="return ";return/^[{[]/.test(a)?(b=new Function(b+a+";"),b()):a==="null"||null===a?"":a},serialize:function(a){var b="",c=[];if(a instanceof Array){b="[";for(var d=0,e=a.length;d<e;d++)switch(typeof a[d]){case"object":c.push(this.serialize(a[d]));break;case"string":c.push("'"+this.safetyFilter(a[d])+"'");break;default:c.push(a[d])}b+=c.join(",")+"]"}else{if(!WebIM.isPlainObject(a))return a;b="{";for(var f in a){var g=f+":";switch(typeof a[f]){case"object":g+=this.serialize(a[f]);break;case"string":g+="'"+this.safetyFilter(a[f])+"'";break;default:g+=a[f]}c.push(g)}b+=c.join(",")+"}"}return b},safetyFilter:function(a){return a.replace(/'/g,"\u2019").replace(/{/g,"\u300e").replace(/}/g,"\u300f").replace(/\[/g,"\u3010").replace(/\]/g,"\u3011")},del:function(a){return N.del(a),this},clear:function(){return N.clear()},onstorage:function(a,b){return N.onstorage(a,b)}},WebIM.Storage=new C;var F="http://chat.im.zhubajie.com/assets/proxy.html",G;document.domain="zhubajie.com";var H=document.createElement("iframe"),I,J,K,L,M;H.style.display="none",H.src=F,H.id="userDataProxy",c.ieProxy=!0,H.onload=H.onreadystatechange=function(){P.test(H.readyState)&&(window.localStorage?(M=H.contentWindow,L=M.document,K=M.localStorage):(L=window.frames.userDataProxy.document,M=H.contentWindow,G=L.createElement("input"),G.type="hidden",G.addBehavior("#default#userData"),window.frames.userDataProxy.document.body.appendChild(G)),c.ieProxy=!1,H.onload=H.onreadystatechange=null)},document.body.appendChild(H);var N=window.localStorage?function(){return{get:function(a,b){return K.getItem(a)},set:function(a,b,c){return K.setItem(a,b)},del:function(a){return K.removeItem(a)},clear:function(){return K.clear()},onstorage:function(a,b){E(this,a,b)},useTimer:WebIM.Browser.ie&&WebIM.Browser.ie<8||WebIM.Browser.chrome,triggerSelf:WebIM.Browser.ie||parseInt(WebIM.Browser.firefox,10)<4,interval:1e3}}():function(){var a="local_storage";return{get:function(b,c){if(G)return G.load(a),G.getAttribute(b)},set:function(b,c){G&&(G.load(a),c===null&&(c=""),G.setAttribute(b,c),G.save(a))},del:function(b){G&&(G.load(a),G.removeAttribute(b),G.save(a))},clear:function(){},onstorage:function(a,b){E(this,a,b)},useTimer:!0,triggerSelf:!0,interval:1e3}}();window.PAGEUUID=function(){var b=window.location.href,c=16777619;for(var d=b.length-1;d>=0;d--)c^=(c<<5)+b.charCodeAt(d)+(c>>2);return window.PAGEUID=c&2147483647,window.PAGEUID+a}();var O=/^function\s*(\(evt\)|onclick\s*\(event\)|anonymous\s*\(\)|anonymous\s*\(event\)|onclick\s*\(\))\s*{\s*WebIM.message/i,P=/(loaded|complete|undefined)/i,Q=/^\d{4}([\/-]\d{1,2}){2}\s*\d{1,2}(:\d{1,2}){2}$/,R="",S="",T=a;U.prototype={eventlist:{},addListener:function(a,b,c,d){var e,f;c?e={caller:b,context:c,argus:d||[]}:e=b,!typeof this.eventlist[a]==="undefined"?this.eventlist[a]=e:(this.eventlist[a]instanceof Array||(f=this.eventlist[a],this.eventlist[a]=[],f&&this.eventlist[a].push(f)),this.eventlist[a].push(e))},on:function(a,b,c,d){this.addListener(a,b,c,d)},emit:function(a){typeof this.eventlist[a]!="undefined"&&this.__caller(a)},__caller:function(a){var b=this.eventlist[a];if(b instanceof Array)for(var c=0,d=b.length;c<d;c++)this.__runcaller(b[c]);else this.__runcaller(b)},__runcaller:function(a){if(typeof a=="function")return a();var b=a.caller;b.apply(a.context,a.argus)}};var V=function(a){this.options=c.extend({channelURI:"http://chat.im.zhubajie.com/chat/init?jsoncallback=WebIM"+T,pollingURI:"http://push{s}.im.zhubajie.com/sub/",sendURI:"http://chat.im.zhubajie.com/chat/textmsg",settingURI:"http://chat.im.zhubajie.com/chat/setup",onlineURI:"http://chat.im.zhubajie.com/chat/checkonline",getMessageURI:"http://chat.im.zhubajie.com/chat/getunread",messgeMP3:"http://t4.zbjimg.com/c/product/webim/didi.mp3",onlineTime:6e5},a),this.entry()};V.prototype={entry:function(){var a=this;if(!(this.userid=c.cookie("userid")))return!1;this.username=c.cookie("nickname"),this.options.pollingURI=this.options.pollingURI.replace("{s}",parseInt(this.userid,10)%2?1:2),V.Client.create(),setTimeout(function(){V.CPageGroup=new V.CPageGroup(a)},0)},message:function(a,d,e,f,g,h,i){var j,k;if(!(j=c.cookie("userid")))return alert("\u8bf7\u5148\u767b\u5f55");if(a==b.userid)return alert("\u4e0d\u80fd\u81ea\u5df1\u7ed9\u81ea\u5df1\u53d1\u4fe1\u606f\uff01");try{if("function"!=typeof arguments.callee.caller||!O.test(arguments.callee.caller.toString())||!c.Browser.ie&&!(arguments.callee.caller.arguments[0]instanceof MouseEvent))return alert("\u4e0d\u8981\u975e\u6cd5\u8bbf\u95ee\u54df\uff01\u4eb2\u7231\u7684\uff01")}catch(l){}k=c.$("taskid"),h?(this.usertype=2,c.Storage.set("WB_UTI",a)):this.usertype=1;var m={uid:a,username:d,online:!!e,eventtype:f||k&&k.getAttribute("data-type")||null,eventid:g||k&&k.value||null,eventname:h||k&&k.getAttribute("data-title")||null,extend:i||k&&k.getAttribute("data-wid")||null};b.addMessageByMessageInfo(m),c.Storage.set("WB_NM",m),c.Storage.set("WB_UT",this.usertype),V.CWindow.setUserType(this.usertype)},addMessageByMessageInfo:function(a){var b=V.CContact({uid:a.uid,online:a.online,username:a.username,message:null,event:{type:a.eventtype,id:a.eventid,name:a.eventname,extend:a.extend}}),c={uid:a.uid,online:a.online,username:a.username,event:{type:a.eventtype,id:a.eventid,name:a.eventname,extend:a.extend},message:null};V.CWindow.addContact(b),V.CList.addContactMessage(c)},MCInit:function(){var a=this;V.Client.hide(!0);if(!c.cookie("userid"))return;window["WebIM"+T]=function(d){b.inittime=1;if(d.state==1){a.channel=d.channel,a.setup=d.setup,a.setup||(a.setup={sound:0,popup:0}),a.unread=d.unread||0,c.Storage.set("WB_ST",a.setup.sound+","+a.setup.popup+","+a.unread),a.polling(),a.contacters=d.contacters||null,window["WebIM"+T]=function(){};try{V.CSetting=new V.CSetting}catch(e){}if(d.contacters&&d.contacters instanceof Array){var f=d.contacters;for(var g=0,h=f.length;g<h;g++){var i={uid:f[g].ouserid,online:f[g].isonline,username:f[g].nickname,message:null,event:null,async:1,unread:f[g].unread};V.CList.addContactMessage(i)}}V.Client.show(!0),c.Storage.set("WB_MC",PAGEUUID)}else WebIM.DEBUG("WebIM\u7cfb\u7edf\u521d\u59cb\u5316\u5931\u8d25"),V.Client.hide(!0)},c.jsonp(this.options.channelURI,null,function(){WebIM.DEBUG("WebIM\u7cfb\u7edf\u521d\u59cb\u5316\u5931\u8d25"),V.Client.hide(!0),b.inittime||(b.inittime=1),b.inittime++>5&&(b.MCInit(),V.CPageGroup.clearStorageData())}),setInterval(function(){c.jsonp(a.options.channelURI)},18e5)},polling:function(){var b=this,c=arguments.caller;setTimeout(function(){b.poll&&b.head.removeChild(b.poll),b.head||!b.head&&(b.head=document.getElementsByTagName("head")[0]);var c=b.options.pollingURI+b.channel+"?etag="+R+"&time="+S+"&t="+a++;b.poll=document.createElement("script"),b.poll.async="async",b.poll.type="text/javascript",b.poll.onload=b.poll.onreadystatechange=function(){if(P.test(b.poll.readyState)){var a=+(new Date)-b.pollTime;!b.pollcallback&&a<15e3?(b.pollingtime||(b.pollingtime=1),b.pollingtime++<=5&&b.polling()):(b.polling(),b.ospolling=!1,b.pollingtime=0),b.poll.onload=b.poll.onreadystatechange=null}},b.poll.onerror=function(){b.pollingtime||(b.pollingtime=1);if(b.pollingtime++>5){b.ospolling=!1;return}b.polling()},b.poll.src=c,b.ospolling=!0,b.pollcallback=!1,b.pollTime=+(new Date),b.head.appendChild(b.poll)},250)},sendMessage:function(d,e,f,g,h,i,j){var k=[this.options.sendURI+"?jsoncallback=WebIM_recive"+ ++T];k.push("uid="+b.userid),k.push("userid="+d),k.push("cont="+e.replace(/__END__\d+$/,"")),k.push("time="+ +(new Date)),f&&(k.push("evt_id="+g),k.push("evt_type="+f),k.push("evt_name="+h)),i&&k.push("evt_pid="+i),window["WebIM_recive"+T]=function(d){d.uuid=++a,window.onerror=null;try{delete window["WebIM_recive"+T]}catch(e){window["WebIM_recive"+T]=null}j&&j(d);if(d){if(d.state==-1)return V.CWindow.tips(""+d.msg,6e3);d.state==-2&&(b.noAuth="\u63d0\u793a\uff1a"+d.msg,c.Storage.set("WB_NOAU",b.noAuth))}c.Storage.set("WB_SMPID",PAGEUUID),c.Storage.set("WB_SMC",d),!d.usertype,b.sending=!1},window.onerror=function(){return V.CWindow.tips("",3e3),!0},c.jsonp(k.join("&"),function(){window.onerror=null},function(){window.onerror=null,V.CWindow.tips("",3e3)})},reciveList:[],addReciveListener:function(a,b){this.reciveList.push({callback:a,context:b})},reciveMessage:function(d,e){for(var f=this.reciveList.length-1;f>=0;f--){var g=this.reciveList[f];g.callback.call(g.context,d)}e||(d.uuid=++a,c.Storage.set("WM_RM",d),b.sending=!1),b.setup.sound==1&&(WebIM.Audio.play(b.options.messgeMP3),setTimeout(function(){WebIM.Audio.play(b.options.messgeMP3)},5e3))}},WebIM.callback=function(a,c,d){R=c,S=d,b.pollcallback=!0,a.cont&&(b.reciveMessage(a),window.webkitNotifications&&function(){window.webkitNotifications.checkPermission()>0?window.webkitNotifications.requestPermission(arguments.callee):(V.CList.getAvatarByUID(a.userid),setTimeout(function(){var b=V.iconCache[a.userid],c=window.webkitNotifications.createNotification(b,"\u4f60\u6709\u65b0\u7684\u6d88\u606f",a.cont);c.show(),setTimeout(function(){c.cancel()},5e3)},500))}());if(b.ospolling)return;b.polling()},WebIM.DEBUG=function(a){},V.CPageGroup=function(a){this.Event=new U,this.WebIM=a,this.isMaster()},V.CPageGroup.prototype={isInit:!1,master:!1,isMaster:function(){return this.isInit||this.init(),this.master},unload:function(){var a=this;c.addEvent(window,"unload",function(){c.Storage.set("WB_IAD",""),a.Event.emit("unload")})},clearStorageData:function(){var a=c.Storage.get("STORAGEKEY");if(a){a=(""+a).split(",");for(var b=a.length-1;b>=0;b--)a[b]&&c.Storage.del(a[b]);c.Storage.del("STORAGEKEY")}},masterDeadListener:function(){var a=this;c.Storage.onstorage("WB_MC",function(b){var d=c.Storage.get("WB_CLEN")^0,e=c.Storage.get("WB_CLS"),f;e&&(f=e.shift())&&f==PAGEUUID&&b==0&&(c.Storage.set("WB_MC",f),a.MasterDoit(!0),a.master=!0,c.Storage.set("WB_CLEN",--d),c.Storage.set("WB_CLS",e))})},maintainClientList:function(){this.Event.on("unload",function(){var a=parseInt(c.Storage.get("WB_CLEN")||0,10),b;this.master?a>=0&&c.Storage.set("WB_MC",""):(b=c.Storage.get("WB_CLS"),b instanceof Array&&(c.removeAt(b,PAGEUUID),c.Storage.set("WB_CLEN",--a),c.Storage.set("WB_CLS",b))),c.Storage.set("WB_TIME",+(new Date))},this)},init:function(){var a=parseInt(c.Storage.get("WB_TIME")||0,10),b=+(new Date);this.unload(),b-a>15e3&&this.clearStorageData();var d=c.Storage.get("WB_MC"),e,f=parseInt(c.Storage.get("WB_CLEN")||0,10);if(!d||d=="")this.master=!0,this.MasterDoit();else if(e=c.Storage.get("WB_CLS")||!f)f||(f=0,e=[]),c.Storage.set("WB_CLEN",++f),e.push(PAGEUUID),c.Storage.set("WB_CLS",e),this.masterDeadListener(),this.SlaveDoit(),V.Client.show();this.maintainClientList(),this.Listener(),this.isInit=!0,this.activeDetect()},Listener:function(){c.Storage.onstorage("WB_WS",function(a){a=a.split(","),WebIM.Drag.setPosition(a[0],a[1])}),c.Storage.onstorage("WB_WO",function(a){V.CWindow.toggleByState(a)}),c.Storage.onstorage("WB_CO",function(a){V.CList.toggleByState(a)}),c.Storage.onstorage("WB_NM",function(a){a=c.Storage.unserialize(a),b.addMessageByMessageInfo(a)}),c.Storage.onstorage("WB_NRC",function(a){V.CWindow.removeContact(a),V.CList.removeContact(a)}),c.Storage.onstorage("WB_WT",function(a){V.CWindow.switchTab(a)}),c.Storage.onstorage("WB_SMC",function(a){PAGEUUID!=parseInt(c.Storage.get("WB_SMPID"),10)&&(b.sending=!1,V.CWindow.sendMessageToService(c.Storage.unserialize(a),c.Storage.get("WB_SMCT"),c.Storage.get("WB_SMU")))}),c.Storage.onstorage("WM_RM",function(a){!V.CPageGroup.master&&PAGEUUID!=parseInt(c.Storage.get("WB_SMPID"),10)&&b.reciveMessage(c.Storage.unserialize(a),!0)}),c.Storage.onstorage("WB_NMO",function(a){parseInt(c.Storage.get("WB_NMOU"),10)!=PAGEUUID&&V.CList.addContactToWindow(a)}),c.Storage.onstorage("WB_ST",function(a){var d=a.split(",");c.Storage.get("WB_STUID")^0!=PAGEUUID&&(b.setup.popup=parseInt(d[1],10),b.setup.sound=parseInt(d[0],10))}),c.Storage.onstorage("WB_UT",function(a){V.CWindow.setUserType(a)})},MasterDoit:function(a){this.WebIM.MCInit(),c.Storage.onstorage("WB_SM",function(a){PAGEUUID!=parseInt(c.Storage.get("WB_SMPID"),10)&&b.sendMessage(c.Storage.get("WB_SMU"),a=c.Storage.unserialize(a),c.Storage.get("WB_SMET"),c.Storage.get("WB_SMEI"),c.Storage.get("WB_SMEN"),c.Storage.get("WB_SMEE"),function(b){V.CWindow.sendMessageToService(b,a,c.Storage.get("WB_SMU"))})}),!a&&this.SlaveDoit(!0)},SlaveDoit:function(a){var d,e,f,g,h,i,j,k;if(!a){if(d=c.Storage.get("WB_ST")){d=d.split(","),b.setup={sound:parseInt(d[0],10),popup:parseInt(d[1],10)},b.unread=d[2];try{V.CSetting=new V.CSetting}catch(l){}}c.Storage.onstorage("WB_NOAU",function(a){b.noAuth=a,V.CWindow.tips(a)})}V.CWindow.setUserType(c.Storage.get("WB_UT"));if(e=c.Storage.get("WB_CL")){for(var m in e)V.CList.addContactMessage(e[m]);h=this.initMessage("WB_ML",!0),this.initMessage("WB_MNL");if(f=c.Storage.get("WB_WCL")){for(var n=0,o=f.length;n<o;n++){if(!(g=V.CContact[i=f[n]]))continue;V.CWindow.addContact(g,!0),V.Client.show(!0),V.CWindow.show(!0);if(h&&(j=h[i])){for(var p=0,q=j.length;p<q;p++){var r=j[p],s;r["uid"]==f[n]?V.CWindow.addMessageBody(f[n],V.CMessage({uid:r.uid,username:r.username,message:r.message,eventtype:r.eventtype,eventid:r.eventid,eventname:r.eventname,extend:r.extend,sendtime:r.sendtime}).setRead(),g,r.notice):V.CWindow.sendMessageToService({msg:r.notice},r.message,f[n],!0)}V.CWindow.scrollList[i].reset(!0)}V.CList.makeReadByClick(i)}V.CWindow.toggleByState(c.Storage.get("WB_WO")),V.CWindow.switchTab(c.Storage.get("WB_WT"))}}},activeDetect:function(){var a=c.Storage.get("WB_IAD");a||(a={}),a[PAGEUUID]=+(new Date),c.Storage.set("WB_IAD",a),setInterval(function(){var a=c.Storage.get("WB_CLS"),b=a?a.length:0,d=c.Storage.get("WB_IAD"),e=+(new Date),f=c.Storage.get("WB_MC");if(a){for(var g=a.length-1;g>=0;g--)if(!d[a[g]]||e-parseInt(d[a[g]],10)>8e3){a.splice(g,1);try{delete d[a[g]]}catch(h){}}b!=a.length&&(c.Storage.set("WB_CLS",a),c.Storage.set("WB_CLEN",a.length))}d[f]&&e-parseInt(d[f],10)>8e3&&c.Storage.set("WB_MC",""),d[PAGEUUID]=e,c.Storage.set("WB_IAD",d),c.Storage.set("WB_TIME",e)},4e3)},initMessage:function(a,b){var d=c.Storage.get(a),e;if(d)for(var f in d){var g=d[f];if(e=V.CContact[f])for(var h=0,i=g.length;h<i;h++)b?g[h]["uid"]==f&&e.addMessage(g[h]):e.addNewMessage(g[h])}return d}},V.CUphold=function(){},V.CUphold.prototype={addMessage:function(a,b,d){d=d||"WB_ML";if(!V.CPageGroup.master&&d=="WB_ML")return;var e=c.Storage.get(d);if(!e||e=="null")e={};e[a]||(e[a]=[]);if(b instanceof Array){for(var f=e.length-15-b.length;f>=0;f--);for(var g=0,f=b.length;g<f;g++)e[a].push(b[g])}else!(e.length>15),e[a].push(b);c.Storage.set(d,e)},removeMessage:function(a,b){var d=c.Storage.get("WB_ML");d&&d[a]&&(delete d[a],c.Storage.set("WB_ML",d),b&&this.removeNewMessage(a,!0))},addNewMessage:function(a,b){this.addMessage(a,b,"WB_MNL")},removeNewMessage:function(a,b){var d=c.Storage.get("WB_MNL");d&&d[a]&&(!b&&this.addMessage(a,d[a]),delete d[a]),c.Storage.set("WB_MNL",d||{})},addContact:function(a,b){var d=c.Storage.get("WB_CL");d||(d={}),d[a]=b,c.Storage.set("WB_CL",d)},setContactAsync:function(a){var b=c.Storage.get("WB_CL"),d=b[a];d&&(d.async=0),c.Storage.set("WB_CL",b)},removeContact:function(a){var b=c.Storage.get("WB_CL");b&&(delete b[a],c.Storage.set("WB_CL",b))},addWinContact:function(a){var b=c.Storage.get("WB_WCL");b||(b=[]),!1===this.valueAt(b,a)&&b.push(a),c.Storage.set("WB_WCL",b)},removeWinContact:function(a){var b=c.Storage.get("WB_WCL"),d;b&&(!1!==(d=this.valueAt(b,a))&&b.splice(d,1),c.Storage.set("WB_WCL",b))},valueAt:function(a,b){for(var c=a.length-1;c>=0;c--)if(a[c]==b)return c;return!1}},V.CUphold=new V.CUphold,V.Client=function(){},V.Client.prototype={ContactsTabTemplte:'<li class="ui-WebIM-hover"><div><span>{username}<i class="ui-WebIM-icons ui-WebIM-{online}"></i></span></div><a href="#" class="ui-_WebIM-icons ui-WebIM-closeline"></a></li>',ContactsMessageWrapperTemplte:'<div class="ui-WebIM-continner"><div  class="ui-_WebIM-wrapper clearfix"></div></div>',ContactsMessageTemplte:'<div class="ui-WebIM-{sender}"><h4>{username} {timer}<span>{illegal}</span></h4><div><b class="tl"></b><b class="tr"></b><b class="bl"></b><b class="br"></b><b class="ml"></b><p>{message}</p></div><div>',acting:{},create:function(a){var b=this;this.whetherSuspended(),b.createFrame(),V.CList=new V.CList(!0),b.bind(),V.CList.entry(),V.CWindow=new V.CWindow,WebIM.Drag=new WebIM.Drag(this.TaskBar,this.DWindow,this,function(a,b){c.Storage.set("WB_WS",a+","+b)})},delegate:function(a,b,c){this.acting[a]={callback:b,context:c||this}},createFrame:function(){var a=[];this.TaskBar=c.$html('<div id="ui-webim-taskbar" style="display:none;"></div>')[0],a.push('<div id="ui-webim-toolbar" class="ui-webim-icons" style="display:none;" data-acting="list-minimize"><div id="ui-webim-contact" class="ui-webim-icons" style="display:none;"><div><i class="ui-webim-icons"  data-acting="switch-windows"></i><a href="javascript:;" data-acting="switch-windows">Mr.rexs\u5de5\u4f5c\u4f5c\u4f5c\u4f5c\u4f5c\u5ba4</a></div></div>\u6d88\u606f(<span data-acting="list-minimize">0</span>)</div>'),a.push('<div id="ui-webim-fold" style="display:none;"><div class="ui-webim-icons" data-acting="list-minimize"></div></div>'),a.push('<a href="javascript:;" style="display:none;" target="_blank" class="ui-webim-icons" id="ui-webim-offlineMessage">\u79bb\u7ebf\u6d88\u606f(<span>12</span>) &nbsp;\u70b9\u51fb\u67e5\u770b(\u65b0\u7a97\u53e3)</a>'),a.push('<div id="ui-webim-list" style="display:none;"><div id="ui-webim-setting" ><div class="ui-webim-inner"><p>\u6d88\u606f</p><a href="#" class="ui-webim-min ui-webim-icons " data-acting="list-minimize" ></a><a href="javascript:;" class="ui-webim-seting ui-webim-icons" data-acting="list-setting"></a></div><div id="ui-webim-setlist" style ="display:none;"><ul><li data-acting="list-checked"><i class="ui-webim-icons" data-acting="list-checked"></i><b data-acting="list-checked">\u65b0\u6d88\u606f\u65f6\u76f4\u63a5\u5f39\u51fa</b></li><li data-acting="list-checked"><i class="ui-webim-icons" data-acting="list-checked"></i><b data-acting="list-checked">\u65b0\u6d88\u606f\u65f6\u5019\u58f0\u97f3\u63d0\u793a</b></li><li data-acting="list-checked"><i class="ui-webim-icons" data-acting="list-checked"></i><b data-acting="list-checked">\u65b0\u6d88\u606f\u65f6\u5019\u684c\u9762\u63d0\u793a</b></li></ul></div></div><div id="ui-webim-meslist" class="ui-webim-icons"><ul class="clearfix"></ul><p class="nomessage"><i class="ui-webim-icons"></i>\u60a8\u76ee\u524d\u6ca1\u6709\u65b0\u6d88\u606f</p></div><div id="ui-webim-listmore"><a href="http://u.zhubajie.com/chat/mylist" target="_blank">\u67e5\u770b\u5386\u53f2\u6d88\u606f>></a></div></div>'),a.push('<div id="ui-webim-window"><div id="ui-webim-tips">\u4f60\u7684\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff0c\u7cfb\u7edf\u5f02\u5e38\uff01</div><div id="ui-webim-winheader"><div data-acting="window-move"><p data-acting="window-move">\u6d88\u606f\u804a\u5929</p><a href="javascript:;" class="ui-webim-icons ui-webim-min" data-acting="switch-windows"></a></div></div><div id="ui-webim-message" ><div class="ui-webim-left"><ul></ul></div><div class="ui-webim-right">'),a.push("</div></div>"),this.TaskBar.innerHTML=a.join(""),document.body.appendChild(this.TaskBar),this.DFold=c.$("ui-webim-fold"),this.DList=c.$("ui-webim-list"),this.DToolBar=c.$("ui-webim-toolbar"),this.DContact=c.$("ui-webim-contact"),this.DWindow=c.$("ui-webim-window"),this.DSetting=c.$("ui-webim-setlist"),this.DTips=c.$("ui-webim-tips"),this.DOfflineMessage=c.$("ui-webim-offlineMessage"),this.suspended&&c.show(this.DToolBar)},hide:function(){c.hide(this.TaskBar)},show:function(){this.suspended&&c.show(this.TaskBar)},bind:function(a){var b=this;a=a||"click",c.addEvent(this.TaskBar,a,function(a){a=c.fixedEvent(window.event||a);if(a.target.nodeName!=="A"||!/^http/ig.test(a.target.getAttribute("href")))return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,b.handler(a),!1}),V.CList.addListener("addcontactmessage",this.resetNumber,this),V.CList.addListener("readcontactallmessage",this.resetNumber,this),V.CList.addListener("removecontact",this.resetNumber,this)},resetNumber:function(a){var b=0;for(var d in a.contactItem)b+=a.contactItem[d].unreadNumber;c.$tag("span",this.DToolBar)[0].innerHTML=b},handler:function(a){var b=a.target,c;c=b.getAttribute("data-acting"),this.acting[c]&&this.caller(c,a)},caller:function(a,b){var c=this.acting[a];if(c instanceof Array)for(var d in c)this.runCaller(c[d],b);else this.runCaller(c,b)},runCaller:function(a,b){typeof a=="function"?a(b,this):typeof a=="object"&&a.context&&a.caller.call(a.context,b,this)},addListener:function(a,b,c){var d,e;c?d={caller:b,context:c}:d=b,!typeof this.acting[a]=="undefined"?this.cating[a]=d:(this.acting[a]instanceof Array||(e=this.acting[a],this.acting[a]=[e]),this.acting[a].push(d))},whetherSuspended:function(){return this.suspended=!0,!0}},V.Client=new V.Client,V.CWindow=function(){this.Window=V.Client.DWindow,this.Event=new U,this.Left=c.$tag("ul",c.$class("ui-webim-left",this.Window)[0])[0],this.Right=c.$class("ui-webim-right",this.Window)[0],this.Title=c.$tag("p",c.$("ui-webim-winheader"))[0],this.entry()},V.CWindow.prototype={contTpl:'<div class="ui-webim-rcont '+(c.Browser.ie?"":"ui-webim-iphone")+'"><div class="ui-webim-corritor">\u9ed8\u8ba4</div><div class="ui-webim-notice"> <i class="ui-webim-icons ui-webim-noticeico"></i><span>\u4e3a\u4e86\u4fdd\u969c\u60a8\u7684\u8d44\u91d1\u5b89\u5168\uff0c\u8bf7\u901a\u8fc7\u732a\u516b\u6212\u7f51\u8fdb\u884c\u4ea4\u6613\uff01</span><a href="javascript:;" class="ui-webim-icons" data-acting="close-notice" style="display:none;"></a></div><div class="ui-webim-content" ><div class="ui-webim-continner"><div  class="ui-webim-wrapper clearfix"></div></div><div class="ui-webim-textarea"><textarea maxlength="500"></textarea></div> <div  class="ui-webim-button"><a href="javascript:;" data-acting="send-message" class="ui-webim-abutton"></a><span>\u5feb\u6377\u53d1\u9001ctrl+enter</span> <span><a href="http://help.zhubajie.com/827.html" target="_blank" class="ui-webim-ainfo">\u300a\u6d88\u606f\u7cfb\u7edf\u4f7f\u7528\u89c4\u5219\u300b</a></span></div></div>',tabTpl:'<li data-contact="{contact}" data-acting="tab-switch"><div data-acting="tab-switch"><span data-acting="tab-switch">{username}<i data-acting="tab-switch" class="ui-webim-icons ui-webim-{online}"></i></span></div><a href="javascript:;" class="ui-webim-icons ui-webim-closeline" data-acting="tab-close"></a></li>',messageTpl:'<div class="ui-webim-lline"><h4>{username}<span class="sendtime">{sendtime}</span></h4><div><b class="tl"></b><b class="tr"></b><b class="bl"></b><b class="br"></b><b class="mr"></b><p>{message}</p></div></div>',messageTpl1:'<div class="ui-webim-rline"><h4>{username}<span class="sendtime">{sendtime}</span></h4><div><b class="tl"></b><b class="tr"></b><b class="bl"></b><b class="br"></b><b class="mr"></b><p>{message}<span class="notice">{notice}</span></p></div></div>',entry:function(){this.contactList={},this.contactDomList={},this.scrollList={},this.infoList={},this.messageWrapperList={},this.textareaList={},this.currentDom={tab:null,cont:null},this.currentContactUUID=null,this.contactNumber=0,this.bind(),this.DContact=c.$tag("a",V.Client.DContact)[0]},addListener:function(a,b,c){this.Event.addListener(a,b,c)},bind:function(){var a=this;V.Client.addListener("switch-windows",function(a){this.toggle(a)},this),c.addEvent(document,"keyup",function(b){b=c.fixedEvent(window.event||b),b.which==27&&a.toggle(b)}),V.Client.addListener("tab-switch",function(a){if(a.type!=="click")return;var b=c.parent(a.target,"li"),d=b.getAttribute("data-contact");this.switchTab(d),c.removeClass(b,"ui-webim-tips-tab"),c.Storage.set("WB_WT",d)},this),V.Client.addListener("tab-close",function(a){if(a.type!="click")return;var b=c.parent(a.target,"li").getAttribute("data-contact");this.removeContact(b),V.CList.removeContact(b),c.Storage.set("WB_NRC",b)},this),V.CList.addListener("removecontact",function(b){a.removeContact(b.lastRemoveContactUID,!0)},a),V.Client.addListener("close-notice",function(a){this.hideNotice()},this),V.Client.addListener("send-message",function(a){if(a.type!=="click")return;this.sendMessage()},this),c.addEvent(document,"keyup",function(b){b=c.fixedEvent(window.event||b),b.ctrlKey&&b.keyCode==13&&a.sendMessage()}),this.hide(!0)},addContact:function(a,b){var d,e,f,g,h;this.contactShow||this.showContact(),this.show(b);if(typeof a!="object")return!1;if(!(d=a.uid)&&a.pageX){if(a.type!=="click")return;e=c.parent(a.target,"li"),d=e.getAttribute("data-contact")^0;if(!(a=V.CContact[d]))return}else(d=a.uid)?(g=V.CContact[a])||(a.message=null,h=a,V.CList.addContactMessage(a.ContactD,b),a=V.CList.contactItem[d],h.eventid&&(a.lastevent={id:h.eventid||null,name:h.eventname||null,type:h.eventtype||null,extend:h.extend||null})):a instanceof V.CContact&&(d=a.ContactD.uid);(g=this.contactDomList[d])?b?this.addTipsForTab(d):(this.switchTab(d),c.Storage.set("WB_WT",d)):(this.addTabCont(d,a,b),!b&&c.Storage.set("WB_WT",d)),this.resetCorritor(a),V.CWindow.show(b)},addTipsForTab:function(a){var b=this.contactDomList[a]?this.contactDomList[a].tab:null;b&&!this.isActiveTab(a)&&c.addClass(b,"ui-webim-tips-tab")},resetCorritor:function(a){var b=a.ContactD.uid;if(a.lastevent.id){var c=V.CList.getSummaryByCContact(a);this.showCorritor(b,c)}else this.hideCorritor(b)},removeContact:function(a,b){var d;if(!this.contactDomList[a])return;this.contactNumber--,this.contactNumber||(this.hideContact(),this.hide(),this.currentDom={uid:null,tab:null,cont:null});if(this.currentDom.uid==a){this.currentDom={uid:null,tab:null,cont:null};var e=c.$tag("li",this.Left);e.length&&this.switchTab(e[0].getAttribute("data-contact"))}d=this.contactDomList[a],this.Left.removeChild(d.tab),this.Right.removeChild(d.cont),this.lastRemoveContactUID=a,delete this.contactDomList[a],delete this.contactList[a],delete this.scrollList[a],delete this.messageWrapperList[a],delete this.textareaList[a],this.Event.emit("removeContact")},addTabCont:function(a,b,d){var e,f,g={},h={},i=this;this.overload(),this.contactNumber++,g.online=b.online?"online":"offline",g.username=b.ContactD.username,g.contact=b.ContactD.uid,e=c.$html(c.tpl(this.tabTpl,g))[0],f=c.$html(this.contTpl)[0],this.contactDomList[a]={tab:e,cont:f,uid:a},this.Left.appendChild(e),this.Right.appendChild(f),this.contactList[a]=b,this.switchTab(a),this.scrollList[a]=c.Scroll({wrapper:c.$class("ui-webim-continner",f)[0],content:c.$class("ui-webim-wrapper",f)[0]}),(!this.currentDom.uid||this.currentDom.uid==a)&&this.scrollList[a].reset(!0),b.addListener("changeevent",function(a){this.resetCorritor(a)},this),b.addListener("addnewmessage",function(a){this.addMessage(a,!0)},this),V.CUphold.addWinContact(a)},addMessage:function(a,b){var c=a.newmessageList,d=a.ContactD.uid;if(this.contactDomList&&this.contactDomList[d]){for(var e in c)c[e]&&this.addMessageBody(d,c[e],a);V.CList.makeReadByClick(d),this.scrollList[d].reset(!0),!b&&this.switchTab(d)}},addMessageBody:function(a,b,d,e){var f={type:"lline"},g;if(!b)return;f.sendtime=this.stamp2time(b.CMessageD.sendtime),f.username=d.ContactD.username,f.message=b.CMessageD.message,f.notice=e!==!0?e||"":"";if(e!==!0){var h=c.$html(c.tpl(this.messageTpl,f))[0];(g=this.messageWrapperList[a])||(g=this.messageWrapperList[a]=c.$class("ui-webim-wrapper",this.contactDomList[a].cont)[0]),g.appendChild(h)}if(arguments.length==3||e===!0){var i=c.Storage.get("WB_SMC");V.CUphold.addMessage(a,{uid:a,username:f.username,message:f.message,sendtime:f.sendtime,eventtype:b.CMessageD.eventtype,eventid:b.CMessageD.eventid,eventname:b.CMessageD.eventname,extend:b.CMessageD.extend,notice:i&&i.state&&i.state==-1?i.msg:""})}},sendMessage:function(d){var e=this.currentDom.uid,f=this.currentDom.cont,g,h=this;(g=this.textareaList[e])||(g=this.textareaList[e]=c.$tag("textarea",f)[0]);if(!d){var i=+(new Date),j;if(j=(""+g.value).replace(/\n$/g,"")){if(b.lastsendtime&&i-b.lastsendtime<2e3)return V.CWindow.tips("\u63d0\u793a\uff1a\u60a8\u53d1\u9001\u6d88\u606f\u7684\u9891\u7387\u8fc7\u5feb\uff0c\u8bf7\u7a0d\u540e\u53d1\u9001",2e3);b.lastsendtime=i;var k=this.contactList[e],l=j,m;if(j.length>300)return V.CWindow.tips("\u63d0\u793a\uff1a\u60a8\u53d1\u9001\u6d88\u7684\u5b57\u6570\u8d85\u8fc7\u9650\u5236\uff0c\u8bf7\u5206\u6761\u53d1\u9001",2e3);j=WebIM.Filter.filter(j),c.Storage.set("WB_SMU",e),c.Storage.set("WB_SMCT",l);var n=PAGEUUID,o=k.lastevent,p=o.type,q=o.id,r=o.name,s=o.extend||null;c.Storage.set("WB_SMEI",o.id),c.Storage.set("WB_SMET",o.type),c.Storage.set("WB_SMEN",o.name),c.Storage.set("WB_SMEE",o.extend),b.noAuth&&(m={state:-1,msg:"\u6d88\u606f\u53d1\u9001\u5931\u8d25",uid:++a}),j.change?(b.sending=!0,c.Storage.set("WB_SM",l+"__END__"+ ++a),V.CPageGroup.master?b.sendMessage(e,j.result,p,q,r,s,function(a){h.sendMessageToService(a,l,e),a.state==-1?V.CWindow.tips("\u63d0\u793a\uff1a\u4f60\u4e0a\u4e00\u6761\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff0c\u539f\u56e0\uff1a"+a.msg,2e3):a.state==-2&&V.CWindow.tips("\u63d0\u793a\uff1a"+a.msg)}):n-=1,m=m||{state:1,uid:++a}):(m=m||{state:-1,msg:"\u5b58\u5728\u975e\u6cd5\u4fe1\u606f\uff0c\u53d1\u9001\u5931\u8d25\uff01",uid:++a},c.Storage.set("WB_SMC",m),b.sending=!1,this.sendMessageToService(m,l,e)),g.value="",c.Storage.set("WB_SMPID",n)}else V.CWindow.tips("\u63d0\u793a\uff1a\u60a8\u53d1\u9001\u7684\u6d88\u606f\u4e3a\u7a7a\uff0c\u8bf7\u8f93\u5165\u6d88\u606f",3e3)}try{g.focus()}catch(t){}},sendMessageToService:function(a,d,e,f){var g=+(new Date),h=this,i={},j,k=e;i.message=d.replace(/__END__\d+$/,""),i.username=b.username||"uoeye.com",i.sendtime=this.stamp2time(g),i.notice=a.msg?"<br/>["+(a.state==-2?"\u6d88\u606f\u53d1\u9001\u5931\u8d25":a.msg)+"]":"",a.state==-2&&V.CWindow.tips("\u63d0\u793a\uff1a"+a.msg);var l=c.$html(c.tpl(h.messageTpl1,i))[0];!(j=h.messageWrapperList[k])&&h.contactDomList[k]&&(j=h.messageWrapperList[k]=c.$class("ui-webim-wrapper",h.contactDomList[k].cont)[0]),j.appendChild(l),h.scrollList[e].reset(!0),!f&&V.CUphold.addMessage(e,{uid:b.userid,username:b.username,message:i.message,sendtime:g,eventid:c.Storage.get("WB_SMEI"),eventtype:c.Storage.get("WB_SMET"),eventname:c.Storage.get("WB_SMEN"),extend:c.Storage.get("WB_SMEE"),notice:a.msg||""})},overload:function(){var a;this.contactNumber>=5&&(a=this.getOnOfflineConstact(!0),a.length?(V.CList.removeContact(a[0].cuid),this.removeContact(a[0].cuid,!0)):(a=this.getOnOfflineConstact(),V.CList.removeContact(a[0].cuid),this.removeContact(a[0].cuid,!0)),this.overload())},getOnOfflineConstact:function(a){var b=[];for(var c in this.contactList){var d=this.contactList[c];if(this.isActiveTab(c))continue;(a?!d.online:d.online)&&a&&d.lasttime>0&&b.push({lasttime:d.lasttime,cuid:c})}if(b.length==0)for(var c in this.contactList){if(this.isActiveTab(c))continue;var d=this.contactList[c];(a?!d.online:d.online)&&b.push({lasttime:d.lasttime,cuid:c})}return b.sort(function(a,b){return a.lasttime>b.lasttime?1:-1})},isActiveTab:function(a){return this.currentDom.uid===a},switchTab:function(a){var b=this.contactDomList[a];this.scrollList[a]&&this.scrollList[a].reset(!0);if(a==this.currentDom.uid)return;if(!b)return;c.addClass(b.tab,"ui-webim-hover"),c.removeClass(b.tab,"ui-webim-tips-tab"),c.show(b.cont),this.currentDom.tab&&c.removeClass(this.currentDom.tab,"ui-webim-hover"),this.currentDom.cont&&c.hide(this.currentDom.cont),b.uid=a,this.currentDom=b,this.currentContactUUID=a,this.resetTitle(this.contactList[a]),this.show(!0),c.Storage.get("WB_UTI")==a&&this.setUserType(2)},setUserType:function(a){var b;if(b=c.$class("ui-webim-notice",this.currentDom.cont)[0]){var d=c.$tag("span",b)[0];d.innerHTML=a==1?"\u4e3a\u4e86\u4fdd\u969c\u60a8\u7684\u8d44\u91d1\u5b89\u5168\uff0c\u8bf7\u901a\u8fc7\u732a\u516b\u6212\u7f51\u8fdb\u884c\u4ea4\u6613\uff01":"\u8bf7\u52ff\u7559\u4e0b\u8054\u7cfb\u65b9\u5f0f\uff0c\u8fdd\u8005\u5c01\u53f7\uff01"}},stamp2time:function(a){var b,c=[],d=[],e,f,g,h,i,j;return Q.test(a)?a:(a=parseInt(a,10),b=new Date(a),c=this.getDB([b.getFullYear(),b.getMonth()+1,b.getDate()]),d=this.getDB([b.getHours(),b.getMinutes(),b.getSeconds()]),d.join(":"))},getDB:function(a){for(var b=a.length-1;b>=0;b--)a[b]<10&&(a[b]="0"+a[b]);return a},resetTitle:function(a){var b=a.ContactD.username+" - \u6d88\u606f\u804a\u5929";this.Title.innerHTML=b,this.DContact.innerHTML=a.ContactD.username},toggle:function(a){if(a.type!=="click"&&a.type!=="keyup")return;this.isshow?this.hide():(this.show(),this.sendMessage(!0))},toggleByState:function(a){a^!1?this.show(!0):this.hide(!0)},show:function(a){if(this.contactNumber<=0)return;this.isshow=!0,c.show(this.Window),this.showContact(),this.currentDom.uid&&this.scrollList[this.currentDom.uid]&&this.scrollList[this.currentDom.uid].reset(!0),c.addClass(V.Client.DContact,"ui-webim-conact"),!a&&c.Storage.set("WB_WO",1)},hide:function(a){this.isshow=!1,c.hide(this.Window),this.contactNumber<=0&&this.hideContact(),c.removeClass(V.Client.DContact,"ui-webim-conact"),!a&&c.Storage.set("WB_WO",0)},showContact:function(){this.contactShow=!0,c.show(V.Client.DContact)},hideContact:function(){this.contactShow=!1,c.hide(V.Client.DContact)},hideNotice:function(){var a=this.currentDom.cont,b=c.$class("ui-webim-notice",a)[0];c.hide(b);var d=this.currentDom.uid,e=this.scrollList[d].maxHeight+=30;this.scrollList[d].maxHeight=e,this.resetHeight(d,a,e),this.hideNoticeUUID=d,this.Event.emit("hidenotice")},showCorritor:function(a,b){var d=this.contactDomList[a].cont,e=this.scrollList[a].maxHeight,f=c.$class("ui-webim-corritor",d)[0];e>202&&(e-=30,this.scrollList[a].maxHeight=e),c.show(f),f.innerHTML=b,this.resetHeight(a,d,e)},hideCorritor:function(a){var b=this.contactDomList[a].cont,d=this.scrollList[a].maxHeight;d<=231&&(d+=30),this.scrollList[a].maxHeight=d,c.hide(c.$class("ui-webim-corritor",b)[0]),this.resetHeight(a,b,d)},resetHeight:function(a,b,d){this.scrollList[a].resetHeight(),c.setStyle(c.$class("ui-webim-continner",b)[0],"height",d+"px"),c.setStyle(c.$class("ui-webim-content",b)[0],"height",d+"px"),this.scrollList[a]&&this.scrollList[a].reset()},tips:function(a,b){a=a||"\u6d88\u606f\u53d1\u9001\u5f02\u5e38",V.Client.DTips.innerHTML=a,this.showtips(),b&&setTimeout(this.hidetips,b)},showtips:function(){c.show(V.Client.DTips)},hidetips:function(){c.hide(V.Client.DTips)}},V.CContact=function(a,b){var d;if(!(this instanceof V.CContact))return new V.CContact(a,b);this.ContactD=c.extend({uid:null,online:!1,username:null,message:null,event:null,async:0},a),this.async=this.ContactD.async,this.online=this.ContactD.online,V.CContact[this.ContactD.uid]=this,this.entry()},V.CContact.prototype={acting:{},entry:function(){var a,b=this;this.messageList={},this.newmessageList={},this.unreadNumber=0,this.lasttime=0,setTimeout(function(){b.lasttime==0&&(b.lasttime=1)},6e4),this.lastevent=this.ContactD.event||{type:null,id:null,name:null,extend:null},typeof this.ContactD.onBeforeAddMessage=="function"&&this.ContactD.onBeforeAddMessage(this)},caller:function(a){var b=this.acting[a];if(b instanceof Array)for(var c in b)this.runCaller(b[c]);else this.runCaller(b)},runCaller:function(a){typeof a=="function"?a(this):typeof a=="object"&&a.context&&a.caller.call(a.context,this)},addListener:function(a,b,c){var d,e;c?d={caller:b,context:c}:d=b,!typeof this.acting[a]==="undefined"?this.cating[a]=d:(this.acting[a]instanceof Array||(e=this.acting[a],this.acting[a]=[e]),this.acting[a].push(d))},setEvent:function(a){var b=a.CMessageD.eventid,c=a.CMessageD.eventname,d=a.CMessageD.eventtype,e=a.CMessageD.extend,f=this.lastevent.id,g=this.lastevent.name,h=this.lastevent.type,i=this.lastevent.extend;if(b!=f||c!=g||d!=h||i!=e)this.lastevent.id=b,this.lastevent.name=c,this.lastevent.type=d,this.lastevent.extend=e,this.acting.changeevent&&this.caller("changeevent")},addMessage:function(a,b){var c=a instanceof V.CMessage?a:V.CMessage(a,this.ContactD.uid),d;return this.lasttime=c.CMessageD.sendtime,c.isUnread?this.addNewMessage(c):(d=c.uuid,this.messageList[d]=c,this.acting.addmessage&&this.caller("addmessage"),this.setEvent(c),d)},addNewMessage:function(a,b){var c=a instanceof V.CMessage?a:V.CMessage(a,this.ContactD.uid),d;return d=c.uuid,this.lasttime=c.CMessageD.sendtime,this.newmessageList[d]=c,this.unreadNumber++,this.acting.addnewmessage&&this.caller("addnewmessage"),this.setEvent(c),d},setOnline:function(){this.online=!0},setOffline:function(){this.online=!1},readNewMessage:function(){this.unreadNumber=0,this.acting.readnewmessage&&this.caller("readnewmessage");for(var a in this.newmessageList){var b=this.newmessageList[a];b&&(b.setRead(),this.messageList[b.uuid]=b)}this.newmessageList={},this.unreadNumber=0,V.CUphold.removeNewMessage(this.ContactD.uid)},reset:function(){return this.acting.reset&&this.caller("reset"),this.messageList={},this.newmessageList={},this.unreadNumber=0,this.lasttime=0,this.lastevent={type:null,id:null,name:null,extend:null},this}},V.CList=function(a){this.List=V.Client.DList,this.Fold=V.Client.DFold,this.ContactList=c.$("ui-webim-meslist"),!a&&this.entry()},V.CList.prototype={acting:{},ContactsListTemplte:'<li data-contact="{contactuid}"><div class="ui-webim-avatar"><img src="{avatar}" onerror="this.onerror=null;this.src=\'http://face.zbjimg.com/images/face_small.gif\'" width="32" height="32" /><i class="ui-webim-icons ui-webim-{online}" width="32" height="32"></i></div><div class="ui-webim-letterhead" data-acting="message-open"><p class="ui-webim-username"  data-acting="message-open">{username} <span  data-acting="message-open">({newmessage})</span></p> <p  data-acting="message-open" class="ui-webim-summary">{summary}</p></div><a href="javascript:;" data-acting="remove-constact" class="ui-webim-icons ui-webim-itemclose"></a></li>',entry:function(){this.opened=!1,this.contactItem={},this.contactDomItem={},this.contactNumber=0,this.bind()},bind:function(){var a=this;V.Client.addListener("list-minimize",this.toggle,this),this.scroll=c.Scroll({wrapper:V.CList.ContactList,content:c.$tag("ul",V.CList.ContactList)[0],inleft:!0}),this.addListener("reestscroll",function(){this.scroll.reset()},this),V.Client.addListener("remove-constact",function(a){var b=a.target.parentNode,d=b.getAttribute("data-contact");this.removeContact(d),V.CWindow.removeContact(d),c.Storage.set("WB_NRC",d)},this),V.Client.addListener("message-open",function(a){if(a.type!=="click")return;var b=c.parent(a.target,"li"),d=b.getAttribute("data-contact");this.addContactToWindow(d,!0)},this),setTimeout(function(){b.addReciveListener(function(b){if(b.userid){var c={uid:b.userid,online:!0,event:{id:b.evt_id||null,type:b.evt_type||null,name:b.evt_name||null,extend:b.evt_pid||null},username:b.nickname,message:{uid:b.userid,username:b.nickname,eventid:b.evt_id||null,eventname:b.evt_name||null,eventtype:b.evt_type||null,extend:b.evt_pid||null,message:b.cont,sendtime:b.time}};a.addContactMessage(c)}},a)},10)},addContactMessage:function(a,d){var e,f,g=this;this.contactNumber==0&&(c.hide(c.$tag("p",this.ContactList)[0]),!this.ContactUL&&(this.ContactUL=c.$tag("ul",this.ContactList)[0])),this.overload(),f=typeof a=="object"?a.uid:a;if(typeof this.contactItem[f]=="undefined"){e=V.CContact(c.extend({onBeforeAddMessage:function(a){g.createItem(a),a.addListener("addnewmessage",g.createItem,g)}},a),!0),V.CUphold.addContact(f,a),this.contactItem[f]=e,this.contactNumber++;if(e.async){e.unreadNumber=a.unread||0;for(var h=e.unreadNumber-1;h>=0;h--)e.newmessageList[h]=null;var i=this.contactDomItem[f];c.$tag("span",i)[0].innerHTML="("+e.unreadNumber+")"}}else e=this.contactItem[f];d=a.message&&d?Array.prototype.concat([],a.message,d):a.message||d;if(d)if(d instanceof Array)for(var j in d)e.addMessage(d[j]);else e.addMessage(d);typeof this.acting["addcontactmessage"]!="undefined"&&this.caller("addcontactmessage"),this.caller("reestscroll"),this.resetHeight(),b.setup&&b.setup.popup&&this.addContactToWindow(""+f,!1)},addContactToWindow:function(a,d){a=(""+a).replace(/__END__\d+$/,""),c.Storage.set("WB_NMO",a),c.Storage.set("WB_NMOU",PAGEUUID);var e=this.contactItem[a],f=e.ContactD.username;e.async?(e.async=0,V.CUphold.setContactAsync(a),window.WEBIM_GETMESSAGE=function(a){if(a.state==1){var b=a.data;for(var c=0,g=b.length;c<g;c++){var h=b[c],i=V.CMessage({uid:h.ouserid,username:f,eventtype:h.evt_type||null,eventid:h.evt_id||null,eventname:h.evt_name||null,extend:h.evt_pid||null,message:h.cont,sendtime:h.time^0});e.newmessageList[c]=i}}for(var g=e.newmessageList;g>=0;g--)null===e.newmessageList[g]&&delete e.newmessageList[g];V.CWindow.addContact(e,!d),V.CWindow.addMessage(e,!d)},c.jsonp(b.options.getMessageURI+"?jsoncallback=WEBIM_GETMESSAGE&ouserid="+a+"&uid="+b.userid)):(V.CWindow.addContact(e,!d),V.CWindow.addMessage(e,!d))},overload:function(){var a;this.contactNumber>=10&&(a=this.getOnOfflineConstact(!0),a.length?this.removeContact(a[0].cuid,!0):(a=this.getOnOfflineConstact(),this.removeContact(a[0].cuid,!0)),this.overload())},getOnOfflineConstact:function(a,b){var c=[];for(var d in this.contactItem){var e=this.contactItem[d];if(V.CWindow.isActiveTab(d))continue;if(a?!e.online:e.online)(b||e.lasttime>0)&&c.push({lasttime:e.lasttime,cuid:d}),userid}if(!c.length)for(var d in this.contactItem){var e=this.contactItem[d];if(V.CWindow.isActiveTab(d))continue;(a?!e.online:e.online)&&c.push({lasttime:e.lasttime,cuid:d})}return c.sort(function(a,b){return a.lasttime>b.lasttime?1:-1})},caller:function(a){var b=this.acting[a];if(b instanceof Array)for(var c in b)this.runCaller(b[c]);else this.runCaller(b)},runCaller:function(a){typeof a=="function"?a(this):typeof a=="object"&&a.context&&a.caller.call(a.context,this)},addListener:function(a,b,c){var d,e;c?d={caller:b,context:c}:d=b,!typeof this.acting[a]==="undefined"?this.cating[a]=d:(this.acting[a]instanceof Array||(e=this.acting[a],this.acting[a]=[e]),this.acting[a].push(d))},createItem:function(a){var b=a.ContactD,d=b.uid,e={},f;if(typeof this.contactDomItem[d]=="undefined")e.username=b.username,e.avatar=this.getAvatarByUID(d),e.online=b.online?"online":"offline",e.summary=this.getSummaryByCContact(a),e.contactuid=d,e.newmessage=a.unreadNumber,f=c.$html(c.tpl(this.ContactsListTemplte,e))[0],this.ContactUL||(this.ContactUL=c.$tag("ul",c.$("ui-webim-meslist"))[0]),c.hover(f,function(){c.addClass(f,"ui-webim-listHover")},function(){c.removeClass(f,"ui-webim-listHover")}),this.ContactUL.insertBefore(f,this.ContactUL.firstChild),this.contactDomItem[d]=f,c.$tag("a",c.$("ui-webim-listmore"))[0].innerHTML="\u67e5\u770b\u66f4\u591a>>";else{var g=this.contactDomItem[d];this.resetContact(g,a)}},getSummaryByCContact:function(a){var b=a.lastevent,c=b.type,d;switch(parseInt(c,10)){case 1:d="http://task.zhubajie.com/"+b.id;break;case 2:d="http://task.zhubajie.com/"+b.extend+"/"+b.id;break;case 3:d="http://home.zhubajie.com/goods/view-uid-"+a.ContactD.uid+"-"+b.id+".html";break;default:}return d?'<a href="'+d+'" target="_blank">\u5173\u4e8e\uff1a'+b.name+"</a>":""},getAvatarByUID:function(a){var b=9-(a+="").length,c="",d=[],e,f=a;typeof V.iconCache=="undefined"&&(V.iconCache={});if(V.iconCache[f])return V.iconCache[f];if(b>0){while(b--)c+="0";a=c+a,d[0]=a.substr(0,3),d[1]=a.substr(3,2),d[2]=a.substr(5,2),e="http://face.zhubajie.com/data/avatar/"+d.join("/")+"/"+a.substr(-2)+"_avatar_small.jpg"}return setTimeout(function(){var a=new Image;a.onerror=function(){V.iconCache[f]="http://face.zbjimg.com/images/face_small.gif"},a.src=e},0),V.iconCache[f]=e,e},removeContact:function(a,b){if(typeof a=="object")var d=a.target.parentNode,e=d.getAttribute("data-contact");else var e=a;if(!this.contactDomItem[e])return;this.contactNumber--,this.contactNumber==0&&(c.show(c.$class("nomessage",this.ContactList)[0]),c.$tag("a",c.$("ui-webim-listmore"))[0].innerHTML="\u67e5\u770b\u5386\u53f2\u6d88\u606f>>",this.hide(!0)),this.lastRemoveContactUID=e,this.contactDomItem[e].parentNode.removeChild(this.contactDomItem[e]),delete this.contactItem[e],delete this.contactDomItem[e],(b||a.target&&typeof this.acting.removecontact!="undefined")&&this.caller("removecontact"),this.caller("reestscroll"),V.CUphold.removeContact(e),this.resetHeight()},resetHeight:function(){c.setStyle(this.ContactUL,"height",this.contactNumber*59+"px")},makeReadByClick:function(a){if(typeof a=="object"&&a.pageX){if(a.type!=="click")return;var b=c.parent(a.target,"li"),d=b.getAttribute("data-contact")}else d=a;var e=this.contactDomItem[d],f=this.contactItem[d];this.readContactAllMessage(d,f),this.resetContact(e,this.contactItem[d],!0)},readContactAllMessage:function(a,b){b=b||this.contactItem[a],typeof b!="undefined"&&b.readNewMessage(),typeof this.acting["readcontactallmessage"]!="undefined"&&this.caller("readcontactallmessage")},resetContact:function(a,b,d){var e,f;if(!b)return;e=b.unreadNumber,e>=0&&(c.$tag("span",a)[0].innerHTML="("+e+")"),d||(f=this.getSummaryByCContact(b),c.$class("ui-webim-summary",a)[0].innerHTML=f)},toggle:function(){this.opened?this.hide():this.show(),c.Storage.set("WB_CO",this.opened?1:0)},toggleByState:function(a){a==1?this.show():this.hide()},show:function(){this.opened=!0,c.show(this.List),c.show(this.Fold),c.addEvent(document,"click",V.CList.hide)},hide:function(a){V.CList.opened=!1,c.hide(V.CList.List),c.hide(V.CList.Fold),c.removeEvent(document,"click",V.CList.hide);try{V.CSetting.hide()}catch(a){}a&&c.Storage.set("WB_CO",0)}},V.CSetting=function(a){this.Setting=V.Client.DSetting,this.entry(a)},V.CSetting.prototype={entry:function(a){this.opened=!1,this.SetListItem=c.$tag("li",this.Setting),this.bind(),this.initSetingItem(a)},initSetingItem:function(a){var d=c.Storage.get("WB_ST"),e;if(d){var f=d.split(",");e=[f[0]^0,f[1]^0]}else e=[b.setup.sound,b.setup.popup];this.SetingItem=e;for(var g=this.SetListItem.length-2;g>=0;g--){var h=this.SetListItem[g?0:1];h.setAttribute("data-index",g),this.SetingItem[g]?c.addClass(c.$tag("i",h)[0],"ui-webim-checked"):c.removeClass(c.$tag("i",h)[0],"ui-webim-checked")}c.hide(this.SetListItem[2])},bind:function(){V.Client.addListener("list-setting",this.toggle,this);for(var a in this.SetListItem){var b=this.SetListItem[a];if(typeof b=="number"||b.nodeType!==1)continue;c.mouseenter(b,function(){c.addClass(this,"ui-webim-hover")}),c.mouselever(b,function(){c.removeClass(this,"ui-webim-hover")})}V.Client.addListener("list-checked",this.checked,this)},checked:function(a){var d,e,f;if(a.type!=="mousedown")return;d=a.target.nodeName=="LI"?a.target:a.target.parentNode,e=d.getAttribute("data-index")^0,this.SetingItem[e]==0?c.addClass(c.$tag("i",d)[0],"ui-webim-checked"):c.removeClass(c.$tag("i",d)[0],"ui-webim-checked"),f=this.SetingItem[e]?0:1,this.SetingItem[e]=f,e==0?b.setup.popup=f:b.setup.sound=f,window.webkitNotifications&&function(){window.webkitNotifications.checkPermission()>0?window.webkitNotifications.requestPermission(arguments.callee):window.webkitNotifications.createNotification("","","")}(),window.WebIMSetting=function(){},c.jsonp(b.options.settingURI+"?jsoncallback=WebIMSetting&popup="+this.SetingItem[1]+"&sound="+this.SetingItem[0]+"&uid="+b.userid),c.Storage.set("WB_ST",this.SetingItem[0]+","+this.SetingItem[1]+","+b.unread),c.Storage.set("WB_STUID",PAGEUUID)},toggle:function(a){if(a.type!=="click")return;this.opened?this.hide(a):this.show(a)},show:function(a){this.opened=!0,c.show(this.Setting),this.target||(this.target=a.target),c.addClass(this.target," ui-webim-settingHover"),this.initSetingItem()},hide:function(a){V.CSetting.opened=!1,c.hide(V.CSetting.Setting),V.CSetting.target&&c.removeClass(V.CSetting.target,"ui-webim-settingHover")}},V.CMessage=function(b,d){if(!(this instanceof arguments.callee))return new arguments.callee(b,d);this.CMessageD=c.extend({uid:null,contact:null,username:null,eventtype:null,eventid:null,eventname:null,extend:null,message:null,sendtime:null,usertype:null},b),this.contact=d||this.CMessageD.contact,this.unread=!0,this.uuid=++a,this.format()},V.CMessage.prototype={format:function(a){a=parseInt(a||this.CMessageD.sendtime,10),isNaN(a)?this.CMessageD.sendtime=Q.test(a)?+(new Date(a)):+(new Date):a<13333333333&&(this.CMessageD.sendtime=(a^0)*1e3)},setRead:function(){return this.unread=!1,this},isUnread:function(){return this.unread},serialize:function(a){var b={};return b[this.uuid]={contact:this.contact,uid:this.CMessageD.uid,username:this.CMessageD.username,eventtype:this.CMessageD.eventtype,eventid:this.CMessageD.eventid,eventname:this.CMessageD.eventname,sendtime:this.CMessageD.sendtime,message:this.CMessageD.message},a?b:(c.serialize(b[this.uuid]),b)}};var W=function(){b=new V({}),window.WebIM.message=b.message};c.ieProxy?function(){var a=arguments.callee;setTimeout(function(){c.ieProxy?a():W()},1e3)}():setTimeout(function(){W()},1e3)})()
